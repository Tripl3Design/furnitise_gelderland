<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Sofa Representation</title>

    <style>
        .cloneableObject {
            cursor: pointer;
        }

        .grid-line {
            stroke: lightgray;
            stroke-width: 1;
        }

        #svgContainer,
        #svgDragzone {
            width: 600px;
            height: 600px;
            border: solid 1px black;
        }

        .selected rect,
        .selected path {
            fill: lightgrey;
        }
    </style>

    <script>
        var isDragging = false;
        var objectToClone, objectReplica;
        var ghostImage = { 'isAppendedToOrigin': false, 'isAppendedToDestination': false };

        function objectCloneGet(element) {
            objectToClone = element;
            isDragging = true;

            objectReplica = objectToClone.cloneNode(true);
            objectReplica.style.opacity = "0.5";
            objectReplica.id = "dragImage";
            objectReplica.style.position = "absolute";

            document.getElementById('svgContainer').appendChild(objectReplica);
        }

        function objectCloneDragOrigin(ev, element) {
            if (isDragging) {
                var dragImage = document.getElementById('dragImage');

                if (!ghostImage.isAppendedToOrigin) {
                    element.appendChild(dragImage);
                    ghostImage.isAppendedToOrigin = true;
                    ghostImage.isAppendedToDestination = false;
                }

                dragImage.setAttribute('x', ev.offsetX);
                dragImage.setAttribute('y', ev.offsetY);
            }
        }

        function objectCloneDragDestination(ev, element) {
            if (isDragging) {
                var dragImage = document.getElementById('dragImage');

                if (!ghostImage.isAppendedToDestination) {
                    element.appendChild(dragImage);
                    ghostImage.isAppendedToDestination = true;
                    ghostImage.isAppendedToOrigin = false;
                }

                dragImage.setAttribute('x', ev.offsetX);
                dragImage.setAttribute('y', ev.offsetY);
            }
        }

        function objectCloneDrop(ev, dropzone) {
            if (isDragging) {
                var objectReplica = objectToClone.cloneNode(true);

                // Snap to grid
                var snappedPosition = snapToGrid(ev.offsetX, ev.offsetY);
                objectReplica.setAttribute('x', snappedPosition.x);
                objectReplica.setAttribute('y', snappedPosition.y);

                objectReplica.removeAttribute('onmousedown');
                objectReplica.removeAttribute('onmousemove');
                objectReplica.removeAttribute('onmouseup');
                objectReplica.removeAttribute('onmouseleave');
                objectReplica.setAttribute('onmousedown', 'enableMove(this)');
                objectReplica.setAttribute('onmouseup', 'disableMove(this)');
                objectReplica.id = 'appendedObject';

                // Add class for selection
                objectReplica.classList.add('selectable');

                // Check for collisions with existing seats
                var collidingSeats = checkForCollisions(objectReplica);

                if (collidingSeats.length > 0) {
                    collidingSeats.forEach(function (seat) {
                        seat.querySelector('rect, path').setAttribute('stroke', 'red');
                    });
                }

                document.getElementById('svgDragzone').removeChild(document.getElementById('dragImage'));
                dropzone.appendChild(objectReplica);

                isDragging = false;
            }
        }

        function checkForCollisions(newSeat) {
            var existingSeats = document.querySelectorAll('#svgDragzone .selectable g[name="seat"]');
            var collidingSeats = [];

            existingSeats.forEach(function (existingSeat) {
                var newSeatElement = newSeat.querySelector('rect, path');
                var existingSeatElement = existingSeat.querySelector('rect, path');

                // Get positions and dimensions of new seat
                var newSeatX = parseFloat(newSeatElement.getAttribute('x'));
                var newSeatY = parseFloat(newSeatElement.getAttribute('y'));
                var newSeatWidth = parseFloat(newSeatElement.getAttribute('width'));
                var newSeatHeight = parseFloat(newSeatElement.getAttribute('height'));

                // Get positions and dimensions of existing seat
                var existingSeatX = parseFloat(existingSeatElement.getAttribute('x'));
                var existingSeatY = parseFloat(existingSeatElement.getAttribute('y'));
                var existingSeatWidth = parseFloat(existingSeatElement.getAttribute('width'));
                var existingSeatHeight = parseFloat(existingSeatElement.getAttribute('height'));

                // Check for collision
                if (newSeatX < existingSeatX + existingSeatWidth &&
                    newSeatX + newSeatWidth > existingSeatX &&
                    newSeatY < existingSeatY + existingSeatHeight &&
                    newSeatY + newSeatHeight > existingSeatY) {
                    collidingSeats.push(existingSeat);
                }
            });

            return collidingSeats;
        }

        function disableDrag(e) {
            if (isDragging) {
                e.removeChild(document.getElementById('dragImage'));
                isDragging = false;
                ghostImage.isAppendedToOrigin = false;
                ghostImage.isAppendedToDestination = false;
            }
        }

        function indicateDrag(dropzone) {
            if (isDragging) {
                dropzone.style.cursor = "pointer";
            } else {
                dropzone.style.cursor = "auto";
            }
        }
        var targetObject = {
            'isMoveable': false,
            'isClickedOnce': false,
            'toReAppend': null,
            'toRePosition': null
        };

        function enableMove(ele) {
            // Deselect all other elements
            var selectedObjects = document.querySelectorAll('.selectable');
            selectedObjects.forEach(function (obj) {
                obj.classList.remove('selected');
            });

            // Select the current element
            ele.classList.add('selected');

            targetObject.isMoveable = true;
            targetObject.toReAppend = ele;
            targetObject.toRePosition = ele;
        }

        function reAppend(dropzone) {
            if (targetObject.toReAppend && !targetObject.toReAppend.parentNode) {
                dropzone.appendChild(targetObject.toReAppend);
            }
        }

        function moveObject(ev, target) {
            if (targetObject.isMoveable) {
                if (targetObject.isClickedOnce) {
                    offx = ev.pageX - targetObject.toRePosition.getAttribute('x');
                    offy = ev.pageY - targetObject.toRePosition.getAttribute('y');
                    targetObject.isClickedOnce = false;
                }

                objx = (ev.pageX - offx);
                objy = (ev.pageY - offy);

                // Snap to grid
                var snappedPosition = snapToGrid(objx, objy);
                targetObject.toRePosition.setAttribute('x', snappedPosition.x);
                targetObject.toRePosition.setAttribute('y', snappedPosition.y);
            }
        }

        function disableMove() {
            targetObject.isMoveable = false;
            targetObject.isClickedOnce = true;
        }

        function snapToGrid(x, y) {
            var gridSize = 6; // 6cm in pixels (1cm = 1px)
            return {
                x: Math.round(x / gridSize) * gridSize,
                y: Math.round(y / gridSize) * gridSize
            };
        }

        function deleteSelected() {
            var selectedObject = document.querySelector('.selected');
            if (selectedObject) {
                selectedObject.parentNode.removeChild(selectedObject);
                // Clear the reference to the deleted object
                targetObject.toReAppend = null; // Assuming targetObject.toReAppend was defined somewhere else
            }
        }

        function rotateSelected() {
            var selectedObject = document.querySelector('.selected');
            if (selectedObject) {
                var rotationGroup = selectedObject.querySelector('g');
                if (rotationGroup) {
                    var currentTransform = rotationGroup.getAttribute('transform');
                    var currentRotation = parseFloat(currentTransform.match(/rotate\(([-]*\d+)/)[1]) || 0;
                    var newRotation = (currentRotation + 90) % 360; // Rotate by 90 degrees clockwise
                    var newTransform = currentTransform.replace(/rotate\(([-]*\d+)/, 'rotate(' + newRotation);

                    rotationGroup.setAttribute('transform', newTransform);
                }
            }
        }

        // Event listener for keydown events to handle delete and rotate functionalities
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Delete' || event.key === 'Backspace' || event.keyCode === 46) {
                deleteSelected();
            } else if (event.key === 'r' || event.key === 'R') {
                rotateSelected();
            }
        });
    </script>
</head>

<body>

    <svg id="svgContainer" onmousemove="objectCloneDragOrigin(event, this)" onmouseup="disableDrag(this)">
        <foreignObject width="100%" height="100%">

        </foreignObject>

        <!-- Include the SVG element as cloneable -->
        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124 124" width="124" height="124"
            x="10" y="10" onmousedown="objectCloneGet(this)">
            <g name="chair_96" transform="rotate(0, 62, 62)">
                <g name="seat">
                    <rect fill="white" x="14" y="26" width="96" height="84" stroke="black" stroke-width="2"></rect>
                </g>
                <g name="rests">
                    <rect x="2" y="14" width="24" height="96" fill="white" stroke="black" stroke-width="2"></rect>
                    <rect x="98" y="14" width="24" height="96" fill="white" stroke="black" stroke-width="2"></rect>
                    <rect x="26" y="14" width="72" height="24" fill="white" stroke="black" stroke-width="2"></rect>
                    <line x1="14" y1="26" x2="110" y2="26" stroke="black" stroke-width="1" stroke-dasharray="4"></line>
                    <line x1="14" y1="26" x2="14" y2="114" stroke="black" stroke-width="1" stroke-dasharray="4"></line>
                    <line x1="110" y1="26" x2="110" y2="114" stroke="black" stroke-width="1" stroke-dasharray="4">
                    </line>
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124 124" width="124" height="124"
            x="10" y="130" onmousedown="objectCloneGet(this)">
            <g name="noArmrestsRight_96" transform="rotate(0, 62, 62)">
                <g name="seat">
                    <rect fill="white" x="14" y="26" width="96" height="84" stroke="black" stroke-width="2"></rect>
                </g>
                <g name="rests">
                    <rect x="14" y="14" width="84" height="24" fill="white" stroke="black" stroke-width="2"></rect>
                    <line x1="14" y1="26" x2="96" y2="26" stroke="black" stroke-width="1" stroke-dasharray="4"></line>
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124 124" width="124" height="124"
            x="130" y="130" onmousedown="objectCloneGet(this)">
            <g name="noArmrestsLeft_96" transform="rotate(0, 62, 62)">
                <g name='seat'>
                    <rect fill='white' x='14' y='26' width='96' height='84' stroke='black' stroke-width='2'>
                </g>
                <g name='rests'>
                    <rect x='26' y='14' width='84' height='24' fill='white' stroke='black' stroke-width='2' />
                    <line x1='28' y1='26' x2='110' y2='26' stroke='black' stroke-width='1' stroke-dasharray='4' />
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124 124" width="124" height="124"
            x="10" y="240" onmousedown="objectCloneGet(this)">
            <g name="armrestRight_96" transform="rotate(0, 62, 62)">
                <g name="seat">
                    <rect fill="white" x="14" y="26" width="96" height="84" stroke="black" stroke-width="2"></rect>
                </g>
                <g name="rests">
                    <rect x="98" y="14" width="24" height="96" fill="white" stroke="black" stroke-width="2"></rect>
                    <rect x="14" y="14" width="84" height="24" fill="white" stroke="black" stroke-width="2"></rect>
                    <line x1="14" y1="26" x2="110" y2="26" stroke="black" stroke-width="1" stroke-dasharray="4"></line>
                    <line x1="110" y1="26" x2="110" y2="114" stroke="black" stroke-width="1" stroke-dasharray="4">
                    </line>
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124 124" width="124" height="124"
            x="150" y="240" onmousedown="objectCloneGet(this)">
            <g name="armrestLeft_96" transform="rotate(0, 62, 62)">
                <g name="seat">
                    <rect fill='white' x='14' y='26' width='96' height='84' stroke='black' stroke-width='2'>
                </g>
                <g name="rests">
                    <rect x='2' y='14' width='24' height='96' fill='white' stroke='black' stroke-width='2' />
                    <rect x='26' y='14' width='84' height='24' fill='white' stroke='black' stroke-width='2' />
                    <line x1='14' y1='26' x2='110' y2='26' stroke='black' stroke-width='1' stroke-dasharray='4' />
                    <line x1='14' y1='26' x2='14' y2='114' stroke='black' stroke-width='1' stroke-dasharray='4' />
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox='0 0 196 196' width='196' height='196'
            x="10" y="360" onmousedown="objectCloneGet(this)">
            <g name="armrestLeft_172" transform="rotate(0, 95, 95)">
                <g name='seat'>
                    <rect fill='white' x='2' y='50' width='174' height='102' stroke='black' stroke-width='2'>
                </g>
                <g name="rests">
                    <rect x='164' y='38' width='24' height='96' fill='white' stroke='black' stroke-width='2' />
                    <rect x='2' y='38' width='162' height='24' fill='white' stroke='black' stroke-width='2' />
                    <line x1='2' y1='50' x2='174' y2='50' stroke='black' stroke-width='1' stroke-dasharray='4' />
                    <line x1='176' y1='50' x2='176' y2='132' stroke='black' stroke-width='1' stroke-dasharray='4' />
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox='0 0 196 196' width='196' height='196'
            x="250" y="360" onmousedown="objectCloneGet(this)">
            <g name="armrestRight_172" transform="rotate(0, 95, 95)">
                <g name='seat'>
                    <rect fill='white' x='14' y='50' width='174' height='102' stroke='black' stroke-width='2'>
                </g>
                <g name="rests">
                    <rect x='2' y='38' width='24' height='96' fill='white' stroke='black' stroke-width='2' />
                    <rect x='26' y='38' width='162' height='24' fill='white' stroke='black' stroke-width='2' />
                    <line x1='14' y1='50' x2='184' y2='50' stroke='black' stroke-width='1' stroke-dasharray='4' />
                    <line x1='14' y1='50' x2='14' y2='132' stroke='black' stroke-width='1' stroke-dasharray='4' />
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox='0 0 124 124' width='124' height='124'
            x="140" y="10" onmousedown="objectCloneGet(this)">
            <g name="noArmrests_84" transform="rotate(0, 56, 56)">
                <g name='seat'>
                    <rect fill='white' x='14' y='14' width='84' height='84' stroke='black' stroke-width='2'></rect>
                </g>
                <g name="rests">
                    <rect x='14' y='2' width='84' height='24' fill='white' stroke='black' stroke-width='2'></rect>
                    <line x1='14' y1='14' x2='96' y2='14' stroke='black' stroke-width='1' stroke-dasharray='4'></line>
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 106 106" width="106" height="106"
            x="350" y="10" onmousedown="objectCloneGet(this)">
            <g name="quarterround" transform="rotate(0, 53, 53)">
                <g name="seat">
                    <path d="M 2,2 L 104,2 A 104,104 0 0,1 2,104 L 2,2 Z" fill="white" stroke="black"
                        stroke-width="2" />
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox='0 0 118 118' width='118' height='118'
            x="350" y="200" onmousedown="objectCloneGet(this)">
            <g name="hocker_84" transform="rotate(0, 62, 62)">
                <g name='seat'>
                    <rect x='14' y='14' width='84' height='84' fill='white' stroke='black' stroke-width='2' />
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox='0 0 124 124' width='124' height='124'
            x="350" y="100" onmousedown="objectCloneGet(this)">
            <g name="hocker_96" transform="rotate(0, 62, 62)">
                <g name='seat'>
                    <rect x='2' y='14' width='96' height='84' fill='white' stroke='black' stroke-width='2' />
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox='0 0 106 106' width='106' height='106'
            x="350" y="100" onmousedown="objectCloneGet(this)">
            <g name="coffeetable" transform="rotate(0, 53, 53)">
                <g name='tabletop'>
                    <rect x='2' y='2' width='78' height='102' fill='white' stroke='black' stroke-width='1' />
                    <path d='M 18 104 L 18 57 Q 18 53 14 53 L 2 53' stroke='black' stroke-width='1' fill='none' />
                </g>
            </g>
        </svg>

        <svg class="cloneableObject" xmlns="http://www.w3.org/2000/svg" viewBox='0 0 196 196' width='196' height='196'
            x="350" y="100" onmousedown="objectCloneGet(this)">
            <g name="sidetable" transform="rotate(0, 97, 97)">
                <g name='tabletop'>
                    <rect x='2' y='2' width='192' height='48' fill='white' stroke='black' stroke-width='1' />
                </g>
            </g>
        </svg>
    </svg>

    <svg id="svgDragzone" onmousedown="reAppend(this)" onmouseup="objectCloneDrop(event, this); disableMove();"
        onmousemove="indicateDrag(this); moveObject(event, this); objectCloneDragDestination(event, this)"
        onmouseleave="disableMove()">
        <!-- Rotate button -->
        <rect id="rotateButton" x="60" y="10" width="40" height="20" fill="blue" stroke="black" stroke-width="1"
            onclick="rotateSelected()"></rect>
        <text x="70" y="25" font-family="Verdana" font-size="12" fill="white" style="pointer-events:none;">Rotate</text>

        <!-- Delete button -->
        <rect id="deleteButton" x="10" y="10" width="40" height="20" fill="red" stroke="black" stroke-width="1"
            onclick="deleteSelected()"></rect>
        <text x="20" y="25" font-family="Verdana" font-size="12" fill="white" style="pointer-events:none;">Delete</text>
    </svg>

</body>

</html>